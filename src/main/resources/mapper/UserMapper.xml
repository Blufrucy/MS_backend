<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.msBackend.mapper.UserMapper">
<!--注册-->
    <insert id="register">
        INSERT INTO user (username, password, nickname, phone, email)
        VALUES (#{username}, #{password}, #{nickname}, #{phone}, #{email})
    </insert>

    <!--查找用户动态sql-->
    <select id="finUser" resultType="com.example.msBackend.pojo.User">
        SELECT id, username, password, nickname, phone, email, avatar
        FROM user
        <where>
            <!-- 支持用户名、邮箱、手机号任意一种方式查询 -->
            <if test="username != null and username != ''">
                (username = #{username} OR email = #{username} OR phone = #{username})
            </if>
            <!-- 如果单独传了手机号 -->
            <if test="phone != null and phone != '' and (username == null or username == '')">
                OR phone = #{phone}
            </if>
            <!-- 如果单独传了邮箱 -->
            <if test="email != null and email != '' and (username == null or username == '')">
                OR email = #{email}
            </if>
        </where>
        <!-- 最多返回1条（用户名/手机号/邮箱都是唯一索引） -->
        LIMIT 1
    </select>


    <!-- 原有ResultMap保持不变 -->
    <resultMap id="ProductResultMap" type="com.example.msBackend.pojo.Product">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="original_price" property="originalPrice"/>
        <result column="image_url" property="imageUrl"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>



    <!-- 商品分页查询（支持名称模糊搜索，无 LIMIT） -->
    <select id="listProductsByName" resultMap="ProductResultMap">
        SELECT * FROM product
        <where>
            <if test="productName != null and productName != ''">
                name LIKE CONCAT('%', #{productName}, '%')
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 秒杀商品ResultMap（扩展关联商品字段） -->
    <resultMap id="SeckillProductResultMap" type="com.example.msBackend.pojo.Vo.SeckillProductVO">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="seckill_price" property="seckillPrice"/>
        <result column="stock" property="stock"/>
        <result column="available_stock" property="availableStock"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="product_name" property="productName"/>
        <result column="product_image_url" property="productImageUrl"/>
        <result column="seckill_description" property="seckillDescription"/>
    </resultMap>
    <!-- 秒杀商品分页查询（关联商品表，查询名称、图片） -->
    <select id="listSeckillProductsByName" resultMap="SeckillProductResultMap">
        SELECT sp.*, p.name AS product_name, p.image_url AS product_image_url
        FROM seckill_product sp
        LEFT JOIN product p ON sp.product_id = p.id
        <where>
            <if test="seckillProductName != null and seckillProductName != ''">
                p.name LIKE CONCAT('%', #{seckillProductName}, '%')
            </if>
        </where>
        ORDER BY sp.start_time DESC
    </select>
</mapper>