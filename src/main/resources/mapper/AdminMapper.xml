<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.msBackend.mapper.AdminMapper">

    <!-- 通用结果映射 -->
    <resultMap id="ProductResultMap" type="com.example.msBackend.pojo.Product">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="description" property="description"/>
        <result column="original_price" property="originalPrice"/>
        <result column="image_url" property="imageUrl"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 添加商品 -->
    <insert id="addProduct" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO product (
            name, description, original_price,
            image_url, status, create_time, update_time
        ) VALUES (
                     #{name}, #{description}, #{originalPrice},
                     #{imageUrl}, #{status}, NOW(), NOW()
                 )
    </insert>

    <!-- 根据ID删除商品 -->
    <delete id="deleteProductById">
        DELETE FROM product WHERE id = #{id}
    </delete>

    <!-- 更新商品 -->
    <update id="updateProduct">
        UPDATE product
        <set>
            <if test="name != null and name != ''">name = #{name},</if>
            <if test="description != null">description = #{description},</if>
            <if test="originalPrice != null">original_price = #{originalPrice},</if>
            <if test="imageUrl != null and imageUrl != ''">image_url = #{imageUrl},</if>
            <if test="status != null">status = #{status},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <!-- 根据ID查询商品 -->
    <select id="getProductById" resultMap="ProductResultMap">
        SELECT * FROM product WHERE id = #{id}
    </select>

    <!-- 查询所有商品（支持状态筛选） -->
    <select id="listProducts" resultMap="ProductResultMap">
        SELECT * FROM product
        <where>
            <if test="status != null">status = #{status}</if>
        </where>
        ORDER BY create_time DESC
    </select>


    <resultMap id="SeckillProductResultMap" type="com.example.msBackend.pojo.SeckillProduct">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="seckill_price" property="seckillPrice"/>
        <result column="stock" property="stock"/>
        <result column="available_stock" property="availableStock"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>



    <!-- ========== 秒杀商品SQL（新增） ========== -->
    <!-- 添加秒杀商品 -->
    <insert id="addSeckillProduct" parameterType="com.example.msBackend.pojo.SeckillProduct">
        INSERT INTO seckill_product (
            product_id, seckill_price, stock, available_stock,
            seckill_description, start_time, end_time, status, create_time, update_time
        ) VALUES (
                     #{productId}, #{seckillPrice}, #{stock}, #{availableStock},
                     #{seckillDescription}, #{startTime}, #{endTime}, #{status}, NOW(), NOW()
                 )
    </insert>

    <!-- 删除秒杀商品 -->
    <delete id="deleteSeckillProductById">
        DELETE FROM seckill_product WHERE id = #{id}
    </delete>

    <!-- 更新秒杀商品 -->
    <update id="updateSeckillProduct" parameterType="com.example.msBackend.pojo.SeckillProduct">
        UPDATE seckill_product
        SET
        product_id = #{productId},
        seckill_price = #{seckillPrice},
        stock = #{stock},
        available_stock = #{availableStock},
        seckill_description = #{seckillDescription}, <!-- 新增字段 -->
        start_time = #{startTime},
        end_time = #{endTime},
        status = #{status},
        update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 根据ID查询秒杀商品 -->
    <select id="getSeckillProductById" resultMap="SeckillProductResultMap">
        SELECT * FROM seckill_product WHERE id = #{id}
    </select>

    <!-- 查询秒杀商品列表 -->
    <select id="listSeckillProducts" resultMap="SeckillProductResultMap">
        SELECT * FROM seckill_product
        <where>
            <if test="status != null">status = #{status}</if>
        </where>
        ORDER BY start_time DESC
    </select>

    <!-- 更新秒杀商品状态 -->
    <update id="updateSeckillProductStatus">
        UPDATE seckill_product
        SET status = #{status}, update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- ========== 系统监控统计SQL ========== -->
    <!-- 获取用户总数 -->
    <select id="getTotalUsers" resultType="java.lang.Long">
        SELECT COUNT(*) FROM user
    </select>

    <!-- 获取订单总数 -->
    <select id="getTotalOrders" resultType="java.lang.Long">
        SELECT COUNT(*) FROM `order`
    </select>

    <!-- 获取总销售额（已支付订单） -->
    <select id="getTotalSales" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0) FROM `order` WHERE status = 1
    </select>

    <!-- 获取当前在线用户数（简化实现：返回总用户数的15%作为模拟） -->
    <select id="getCurrentOnlineUsers" resultType="java.lang.Long">
        SELECT FLOOR(COUNT(*) * 0.15) FROM user
    </select>

    <!-- 获取热销商品TOP5 -->
    <select id="getTopProducts" resultType="java.util.HashMap">
        SELECT 
            p.id AS productId,
            p.name AS productName,
            COUNT(o.id) AS sales
        FROM `order` o
        INNER JOIN product p ON o.product_id = p.id
        WHERE o.status = 1
        GROUP BY p.id, p.name
        ORDER BY sales DESC
        LIMIT 5
    </select>

</mapper>