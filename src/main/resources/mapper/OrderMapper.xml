<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.msBackend.mapper.OrderMapper">

    <!-- 根据订单号查询订单 -->
    <select id="findByOrderNo" resultType="com.example.msBackend.pojo.Order">
        SELECT id, order_no, user_id, product_id, seckill_product_id, 
               product_name, quantity, total_amount, status, image_url,
               created_at, payment_time, update_time
        FROM `order`
        WHERE order_no = #{orderNo}
    </select>

    <!-- 根据订单ID查询订单 -->
    <select id="findById" resultType="com.example.msBackend.pojo.Order">
        SELECT id, order_no, user_id, product_id, seckill_product_id, 
               product_name, quantity, total_amount, status, image_url,
               created_at, payment_time, update_time
        FROM `order`
        WHERE id = #{orderId}
    </select>

    <!-- 根据用户ID查询订单列表 -->
    <select id="findByUserId" resultType="com.example.msBackend.pojo.Order">
        SELECT id, order_no, user_id, product_id, seckill_product_id, 
               product_name, quantity, total_amount, status, image_url,
               created_at, payment_time, update_time
        FROM `order`
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 创建订单 -->
    <insert id="insert" parameterType="com.example.msBackend.pojo.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (order_no, user_id, product_id, seckill_product_id, 
                           product_name, quantity, total_amount, status, image_url,
                           created_at, update_time)
        VALUES (#{orderNo}, #{userId}, #{productId}, #{seckillProductId}, 
                #{productName}, #{quantity}, #{totalAmount}, #{status}, #{imageUrl},
                #{createdAt}, #{updateTime})
    </insert>

    <!-- 更新订单状态 -->
    <update id="updateStatus" parameterType="com.example.msBackend.pojo.Order">
        UPDATE `order`
        SET status = #{status},
            payment_time = #{paymentTime},
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <!-- 取消订单 -->
    <update id="cancelOrder">
        UPDATE `order`
        SET status = 2,
            update_time = NOW()
        WHERE id = #{orderId}
    </update>

    <sql id="Base_Column_List">
        id, order_no, user_id, product_id, seckill_product_id,
    product_name, quantity, total_amount, status, image_url,
    created_at, payment_time, update_time
    </sql>

    <!-- 根据订单编号查询 -->
    <select id="selectByOrderNo" parameterType="java.lang.String" resultType="Order">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE order_no = #{orderNo}
    </select>

    <!-- 根据用户ID和秒杀商品ID查询 -->
    <select id="selectByUserIdAndSeckillId" parameterType="map" resultType="Order">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE user_id = #{userId}
        AND seckill_product_id = #{seckillProductId}
    </select>

    <!-- 更新支付状态 -->
    <update id="updatePaymentStatus" parameterType="map">
        UPDATE `order`
        SET status = #{status},
            payment_time = #{paymentTime},
            update_time = NOW()
        WHERE order_no = #{orderNo}
    </update>

    <!-- 查询用户未支付订单 -->
    <select id="selectUnpaidByUserId" parameterType="java.lang.Long" resultType="Order">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE user_id = #{userId}
        AND status = 0
    </select>



</mapper>
