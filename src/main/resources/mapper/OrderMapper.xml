<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.msBackend.mapper.OrderMapper">

    <!-- 根据订单号查询订单 -->
    <select id="findByOrderNo" resultType="com.example.msBackend.pojo.Order">
        SELECT id, order_no, user_id, product_id, seckill_product_id, address_id,
               product_name, quantity, total_amount, status, image_url,
               created_at, payment_time, update_time
        FROM `order`
        WHERE order_no = #{orderNo}
    </select>

    <!-- 根据订单ID查询订单 -->
    <select id="findById" resultType="com.example.msBackend.pojo.Order">
        SELECT id, order_no, user_id, product_id, seckill_product_id, address_id,
               product_name, quantity, total_amount, status, image_url,
               created_at, payment_time, update_time
        FROM `order`
        WHERE id = #{orderId}
    </select>

    <!-- 根据用户ID查询订单列表 -->
    <select id="findByUserId" resultType="com.example.msBackend.pojo.Order">
        SELECT id, order_no, user_id, product_id, seckill_product_id, address_id,
               product_name, quantity, total_amount, status, image_url,
               created_at, payment_time, update_time
        FROM `order`
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 创建订单 -->
    <insert id="insert" parameterType="com.example.msBackend.pojo.Order" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `order` (
            order_no, 
            user_id, 
            product_id, 
            <if test="seckillProductId != null">
                seckill_product_id,
            </if>
            <if test="addressId != null">
                address_id,
            </if>
            product_name, 
            quantity, 
            total_amount, 
            status, 
            image_url,
            created_at, 
            update_time
        )
        VALUES (
            #{orderNo}, 
            #{userId}, 
            #{productId}, 
            <if test="seckillProductId != null">
                #{seckillProductId},
            </if>
            <if test="addressId != null">
                #{addressId},
            </if>
            #{productName}, 
            #{quantity}, 
            #{totalAmount}, 
            #{status}, 
            #{imageUrl},
            #{createdAt}, 
            NOW()
        )
    </insert>

    <!-- 更新订单状态 -->
    <update id="updateStatus" parameterType="com.example.msBackend.pojo.Order">
        UPDATE `order`
        SET status = #{status},
            payment_time = #{paymentTime},
            update_time = #{updateTime}
        WHERE id = #{id}
    </update>

    <!-- 取消订单 -->
    <update id="cancelOrder">
        UPDATE `order`
        SET status = 2,
            update_time = NOW()
        WHERE id = #{orderId}
    </update>

    <sql id="Base_Column_List">
        id, address_id,order_no, user_id, product_id, seckill_product_id,
    product_name, quantity, total_amount, status, image_url,
    created_at, payment_time, update_time
    </sql>

    <!-- 根据订单编号查询 -->
    <select id="selectByOrderNo" parameterType="java.lang.String" resultType="Order">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE order_no = #{orderNo}
    </select>

    <!-- 根据用户ID和秒杀商品ID查询 -->
    <select id="selectByUserIdAndSeckillId" parameterType="map" resultType="Order">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE user_id = #{userId}
        AND seckill_product_id = #{seckillProductId}
    </select>

    <!-- 更新支付状态 -->
    <update id="updatePaymentStatus" parameterType="map">
        UPDATE `order`
        SET status = #{status},
            payment_time = #{paymentTime},
            update_time = NOW()
        WHERE order_no = #{orderNo}
    </update>
<!--    修改订单信息-->
    <update id="updateOrder">
        UPDATE `order`
        SET
        status = IFNULL(#{status}, status),
        payment_time = IFNULL(#{paymentTime}, payment_time),
        address_id = IFNULL(#{addressId}, address_id),
        product_name = IFNULL(#{productName}, product_name),
        quantity = IFNULL(#{quantity}, quantity),
        total_amount = IFNULL(#{totalAmount}, total_amount),
        image_url = IFNULL(#{imageUrl}, image_url),
        update_time = NOW()
        WHERE
        order_no = #{orderNo}
        <!-- 双重校验：订单编号非空 + 主键非空（可选） -->
        AND #{orderNo} IS NOT NULL
        <if test="id != null">
            AND id = #{id}
        </if>
    </update>

    <!-- 查询用户未支付订单 -->
    <select id="selectUnpaidByUserId" parameterType="java.lang.Long" resultType="Order">
        SELECT <include refid="Base_Column_List"/>
        FROM `order`
        WHERE user_id = #{userId}
        AND status = 0
    </select>
<!--    获取全部订单-->
    <select id="listOrder" resultType="com.example.msBackend.pojo.Order">
        SELECT *
        FROM `order`
    </select>


    <select id="selectOrderByUserId" resultType="com.example.msBackend.pojo.Order">
        SELECT *
        FROM `order`
        WHERE user_id = #{userId}
    </select>


</mapper>
